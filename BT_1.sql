USE LAYLOIHOI_DB;
go
CREATE TABLE KHACH_HANG(
MAKH INT PRIMARY KEY, 
TENKH VARCHAR(30),
DIACHI VARCHAR(50),
SODT CHAR(11)
);
go
CREATE TABLE PHONG(
MAPHONG INT PRIMARY KEY,
LOAIPHONG VARCHAR(20),
SOKHACHTOIDA INT,
GIAPHONG DECIMAL(6,3),
MOTA VARCHAR(255)
);

CREATE TABLE DAT_PHONG(
MADATPHONG INT PRIMARY KEY,
MAPHONG INT,
MAKH INT,
NGAYDAT DATE,
GIOBATDAU TIME,
GIOKETTHUC TIME,
TIENDATCOC DECIMAL(6,3),
GHICHU VARCHAR(255),
TRANGTHAIDAT VARCHAR(30),
FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
FOREIGN KEY (MAKH) REFERENCES KHACH_HANG(MAKH)
);
GO
CREATE TABLE DICH_VU_DI_KEM(
MADV INT PRIMARY KEY,
TENDV VARCHAR(255),
DONVITINH VARCHAR(30),
DONGIA DECIMAL(6,3)
);
GO
CREATE TABLE CHI_TIET_SU_DUNG_DV(
MADATPHONG INT,
MADV INT,
SOLUONG INT,
PRIMARY KEY (MADATPHONG, MADV),
FOREIGN KEY (MADATPHONG) REFERENCES DAT_PHONG(MADATPHONG),
FOREIGN KEY (MADV) REFERENCES DICH_VU_DI_KEM(MADV)
);
GO
INSERT INTO PHONG (MAPHONG, LOAIPHONG, SOKHACHTOIDA, GIAPHONG, MOTA) VALUES
(1, 'LOAI 1', 20, 60.000, ''),
(2, 'LOAI 1', 25, 80.000, ''),
(3, 'LOAI 2', 15, 50.000, ''),
(4, 'LOAI 3', 20, 50.000, '');
GO
INSERT INTO KHACH_HANG (MAKH, TENKH, DIACHI, SODT) VALUES
(1, 'MARIA OZAWA', 'HOA XUAN', '11111111111'),
(2, 'TOKUDA', 'HOA XUAN', '11111111112'),
(3, 'MIKAMI YUA', 'HOA XUAN', '11111111113'),
(4, 'NGUYEN VAN D', 'HOA XUAN', '11111111114');
GO
INSERT INTO DICH_VU_DI_KEM (MADV, TENDV, DONVITINH, DONGIA) VALUES
(1, 'HOT GIRL', 'EM', 10.000),
(2, 'HOA HAU', 'EM', 20.000),
(3, 'BEER', 'LON', 10.000),
(4, 'TRAI CAY', 'DIA', 35.000);
GO

INSERT INTO DAT_PHONG (MADATPHONG, MAPHONG, MAKH, NGAYDAT, GIOBATDAU, GIOKETTHUC, TIENDATCOC, GHICHU, TRANGTHAIDAT) VALUES
(1, 1, 2, '2018-03-26', '11:00:00', '13:00:00', 100.000, '', 'DA DAT'),
(2, 1, 3, '2018-03-27', '17:15:00', '19:15:00', 50.000, '', 'DA HUY'),
(3, 2, 2, '2018-03-26', '20:30:00', '22:15:00', 100.000, '', 'DA DAT'),
(4, 3, 1, '2018-04-01', '19:30:00', '21:15:00', 200.000, '', 'DA DAT');
GO

INSERT INTO CHI_TIET_SU_DUNG_DV (MADATPHONG, MADV, SOLUONG) VALUES
(1, 1, 20),
(1, 2, 10),
(1, 3, 3),
(2, 2, 10),
(2, 3, 1),
(3, 3, 2),
(3, 4, 10);
GO
--cau 1:
SELECT MADATPHONG, MADV, SOLUONG FROM CHI_TIET_SU_DUNG_DV WHERE SOLUONG <= 10 AND SOLUONG >=3;
GO

--cau 2:
UPDATE PHONG SET GIAPHONG = GIAPHONG + 10.000 WHERE SOKHACHTOIDA > 10;
GO
SELECT * FROM KHACH_HANG;
GO

--cau 3:
DELETE FROM DAT_PHONG WHERE TRANGTHAIDAT = 'DA HUY';
GO

--cau 4:
SELECT TENKH FROM KHACH_HANG WHERE TENKH LIKE 'H%' OR TENKH LIKE 'N%' OR TENKH LIKE 'M%' AND LEN(TENKH) > 20;
GO

--cau 5:
SELECT DISTINCT TENKH FROM KHACH_HANG;
GO

--cau 6:
SELECT * FROM DICH_VU_DI_KEM WHERE DONVITINH LIKE 'LON' AND DONGIA = '10.000' 
OR DONVITINH LIKE 'CAI' AND DONGIA ='5.000';
GO



--cau 7
SELECT DP.MADATPHONG, P.MAPHONG, P.LOAIPHONG, P.SOKHACHTOIDA, P.GIAPHONG, KH.MAKH,
KH.TENKH, KH.SODT, DP.NGAYDAT, DP.GIOBATDAU, DP.GIOKETTHUC,CSDDV.MADV AS MADICHVU,
CSDDV.SOLUONG, DV.DONGIA FROM DAT_PHONG DP
JOIN PHONG P ON DP.MAPHONG = P.MAPHONG
JOIN KHACH_HANG KH ON DP.MAKH = KH.MAKH
JOIN CHI_TIET_SU_DUNG_DV CSDDV ON DP.MADATPHONG = CSDDV.MADATPHONG
JOIN DICH_VU_DI_KEM DV ON CSDDV.MADV = DV.MADV 
WHERE YEAR(DP.NGAYDAT) = 2016 OR YEAR(DP.NGAYDAT) = 2017 AND P.GIAPHONG > 50.000;
SELECT * FROM KHACH_HANG;
GO

--cau 8:
SELECT DP.MADATPHONG,P.MAPHONG,P.LOAIPHONG,P.GIAPHONG,P.SOKHACHTOIDA,KH.MAKH,DP.NGAYDAT,
P.GIAPHONG * DATEDIFF(MINUTE, DP.GIOBATDAU, DP.GIOKETTHUC) / 60 AS TONGTIENHAT,
SUM(CSDDV.SOLUONG * DV.DONGIA) AS TONGTIENSUDUNGDICHVU,
(P.GIAPHONG * DATEDIFF(MINUTE, DP.GIOBATDAU, DP.GIOKETTHUC) / 60) + 
SUM(CSDDV.SOLUONG * DV.DONGIA) AS TONGTIENTHANHTOAN
FROM DAT_PHONG DP
JOIN PHONG P ON DP.MAPHONG = P.MAPHONG
JOIN KHACH_HANG KH ON DP.MAKH = KH.MAKH
LEFT JOIN CHI_TIET_SU_DUNG_DV CSDDV ON DP.MADATPHONG = CSDDV.MADATPHONG
LEFT JOIN DICH_VU_DI_KEM DV ON CSDDV.MADV = DV.MADV
GROUP BY DP.MADATPHONG, P.MAPHONG, P.LOAIPHONG, P.GIAPHONG, P.SOKHACHTOIDA,
KH.MAKH, DP.NGAYDAT, DP.GIOBATDAU, DP.GIOKETTHUC;
GO

--cau 9:
SELECT * FROM KHACH_HANG WHERE DIACHI= 'HOA XUAN';
GO


--cau 10:
SELECT DP.MADATPHONG, P.LOAIPHONG, P.SOKHACHTOIDA, P.GIAPHONG, CTSD.SOLUONG 
FROM PHONG P 
JOIN DAT_PHONG DP ON P.MAPHONG = DP.MAPHONG
JOIN CHI_TIET_SU_DUNG_DV CTSD ON DP.MADATPHONG = CTSD.MADATPHONG 
WHERE TRANGTHAIDAT LIKE 'DA DAT' AND SOLUONG > 2;
GO




